<div class="validar-receta-container">
  <!-- Header -->
  <div class="header-section">
    <h2>üè• Validaci√≥n de Recetas M√©dicas</h2>
    <p class="subtitle">Sistema de verificaci√≥n para farmacias</p>
  </div>

  <!-- Formulario de validaci√≥n -->
  <div class="validation-form">
    <div class="form-group">
      <label for="codigo">C√≥digo de Validaci√≥n:</label>
      <div class="input-group">
        <input
          type="text"
          id="codigo"
          [(ngModel)]="codigoValidacion"
          placeholder="RX-XXXXXX-XXXXXX"
          class="form-control"
          [disabled]="cargando"
          (keyup.enter)="validarReceta()"
          maxlength="20">
        <button
          (click)="validarReceta()"
          [disabled]="cargando || !codigoValidacion.trim()"
          class="btn btn-primary">
          <span *ngIf="cargando">‚è≥ Validando...</span>
          <span *ngIf="!cargando">üîç Validar</span>
        </button>
      </div>
    </div>

    <!-- Mensaje de validaci√≥n -->
    <div *ngIf="mensajeValidacion"
         class="alert"
         [class.alert-success]="esValida"
         [class.alert-danger]="!esValida">
      {{ mensajeValidacion }}
    </div>
  </div>

  <!-- Informaci√≥n de la receta validada -->
  <div *ngIf="recetaValidada && esValida" class="receta-info">

    <!-- Datos generales -->
    <div class="info-card">
      <h3>üìã Informaci√≥n de la Receta</h3>

      <div class="info-grid">
        <div class="info-item">
          <span class="label">C√≥digo:</span>
          <span class="value codigo">{{ recetaValidada.codigo_validacion }}</span>
        </div>

        <div class="info-item">
          <span class="label">Estado:</span>
          <span class="value estado" [class]="'estado-' + recetaValidada.estado">
            {{ recetaValidada.estado | uppercase }}
          </span>
        </div>

        <div class="info-item">
          <span class="label">M√©dico:</span>
          <span class="value">{{ recetaValidada.medico_nombre || 'No disponible' }}</span>
        </div>

        <div class="info-item">
          <span class="label">Paciente:</span>
          <span class="value">{{ recetaValidada.paciente_nombre || 'No disponible' }}</span>
        </div>

        <div class="info-item">
          <span class="label">Fecha Emisi√≥n:</span>
          <span class="value">{{ formatearFecha(recetaValidada.fecha_emision) }}</span>
        </div>

        <div class="info-item">
          <span class="label">Fecha Vencimiento:</span>
          <span class="value" [class.text-warning]="estaPorVencer(recetaValidada)"
                [class.text-danger]="getDiasRestantes(recetaValidada) <= 0">
            {{ formatearFecha(recetaValidada.fecha_vencimiento) }}
            <small *ngIf="getDiasRestantes(recetaValidada) > 0" class="dias-restantes">
              ({{ getDiasRestantes(recetaValidada) }} d√≠as restantes)
            </small>
            <small *ngIf="getDiasRestantes(recetaValidada) <= 0" class="dias-restantes text-danger">
              (VENCIDA)
            </small>
          </span>
        </div>
      </div>

      <!-- Alerta si est√° por vencer -->
      <div *ngIf="estaPorVencer(recetaValidada)" class="alert alert-warning">
        ‚ö†Ô∏è Esta receta est√° pr√≥xima a vencer. Proceda con precauci√≥n.
      </div>
    </div>

    <!-- Medicamentos -->
    <div class="info-card">
      <h3>üíä Medicamentos Prescritos</h3>

      <div *ngIf="recetaValidada.medicamentos && recetaValidada.medicamentos.length > 0; else noMedicamentos"
           class="medicamentos-list">
        <div *ngFor="let med of recetaValidada.medicamentos; let i = index"
             class="medicamento-item">
          <div class="medicamento-header">
            <span class="medicamento-numero">{{ i + 1 }}</span>
            <h4>{{ med.nombre }}</h4>
            <span *ngIf="med.concentracion" class="concentracion">{{ med.concentracion }}</span>
          </div>

          <div class="medicamento-details">
            <div class="detail-row">
              <span class="detail-label">Forma:</span>
              <span class="detail-value">{{ med.forma_farmaceutica || 'No especificada' }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Cantidad:</span>
              <span class="detail-value cantidad">{{ med.cantidad }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">V√≠a:</span>
              <span class="detail-value">{{ med.via_administracion || 'No especificada' }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Frecuencia:</span>
              <span class="detail-value frecuencia">{{ med.frecuencia }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Duraci√≥n:</span>
              <span class="detail-value duracion">{{ med.duracion }}</span>
            </div>

            <div *ngIf="med.indicaciones_especiales" class="detail-row indicaciones">
              <span class="detail-label">Indicaciones:</span>
              <span class="detail-value">{{ med.indicaciones_especiales }}</span>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noMedicamentos>
        <p class="no-data">No hay medicamentos registrados en esta receta.</p>
      </ng-template>
    </div>

    <!-- Instrucciones generales -->
    <div *ngIf="recetaValidada.instrucciones" class="info-card">
      <h3>üìù Instrucciones Generales</h3>
      <div class="instrucciones-content">
        {{ recetaValidada.instrucciones }}
      </div>
    </div>

    <!-- Observaciones m√©dicas -->
    <div *ngIf="recetaValidada.observaciones" class="info-card">
      <h3>ü©∫ Observaciones M√©dicas</h3>
      <div class="observaciones-content">
        {{ recetaValidada.observaciones }}
      </div>
    </div>
  </div>

  <!-- Formulario de farmacia -->
  <div *ngIf="mostrarFormularioFarmacia && recetaValidada?.estado === 'activa'" class="farmacia-form">
    <div class="info-card">
      <h3>üè™ Informaci√≥n de Dispensaci√≥n</h3>

      <form (ngSubmit)="utilizarReceta()" #farmaciaForm="ngForm">
        <div class="form-group">
          <label for="nombreFarmacia">Nombre de la Farmacia *:</label>
          <input
            type="text"
            id="nombreFarmacia"
            [(ngModel)]="farmaciaInfo.nombre_farmacia"
            name="nombreFarmacia"
            class="form-control"
            required
            placeholder="Ej: Farmacia Central, Cruz Verde, etc."
            [disabled]="cargando">
        </div>

        <div class="form-group">
          <label for="farmaceutico">Farmac√©utico Responsable *:</label>
          <input
            type="text"
            id="farmaceutico"
            [(ngModel)]="farmaciaInfo.farmaceutico_responsable"
            name="farmaceutico"
            class="form-control"
            required
            placeholder="Nombre completo del farmac√©utico"
            [disabled]="cargando">
        </div>

        <div class="form-group">
          <label for="observaciones">Observaciones (opcional):</label>
          <textarea
            id="observaciones"
            [(ngModel)]="farmaciaInfo.observaciones"
            name="observaciones"
            class="form-control"
            rows="3"
            placeholder="Observaciones sobre la dispensaci√≥n..."
            [disabled]="cargando"></textarea>
        </div>

        <div class="form-actions">
          <button
            type="button"
            (click)="resetearFormulario()"
            class="btn btn-secondary"
            [disabled]="cargando">
            üîÑ Cancelar
          </button>

          <button
            type="submit"
            class="btn btn-success"
            [disabled]="cargando || farmaciaForm.invalid">
            <span *ngIf="cargando">‚è≥ Dispensando...</span>
            <span *ngIf="!cargando">‚úÖ Dispensar Medicamentos</span>
          </button>
        </div>
      </form>

      <!-- Advertencia importante -->
      <div class="alert alert-warning mt-3">
        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Una vez dispensados los medicamentos, la receta ser√° marcada como utilizada
        y NO podr√° ser usada nuevamente. Aseg√∫rese de que toda la informaci√≥n sea correcta antes de continuar.
      </div>
    </div>
  </div>

  <!-- Informaci√≥n si ya fue utilizada -->
  <div *ngIf="recetaValidada && recetaValidada.estado === 'utilizada'" class="info-card dispensacion-info">
    <h3>‚úÖ Receta Ya Dispensada</h3>

    <div class="dispensacion-details">
      <div class="detail-row">
        <span class="detail-label">Farmacia:</span>
        <span class="detail-value">{{ recetaValidada.farmacia_utilizada || 'No registrada' }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Farmac√©utico:</span>
        <span class="detail-value">{{ recetaValidada.farmaceutico_responsable || 'No registrado' }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Fecha de dispensaci√≥n:</span>
        <span class="detail-value">{{ formatearFecha(recetaValidada.fecha_utilizacion) }}</span>
      </div>

      <div *ngIf="recetaValidada.observaciones_farmacia" class="detail-row">
        <span class="detail-label">Observaciones:</span>
        <span class="detail-value">{{ recetaValidada.observaciones_farmacia }}</span>
      </div>
    </div>

    <div class="alert alert-info">
      <strong>‚ÑπÔ∏è Esta receta ya fue utilizada</strong> y no puede ser dispensada nuevamente.
    </div>
  </div>

  <!-- Bot√≥n para nueva b√∫squeda -->
  <div *ngIf="recetaValidada" class="actions-section">
    <button (click)="resetearFormulario()" class="btn btn-outline-primary">
      üîç Validar Nueva Receta
    </button>
  </div>
</div>
