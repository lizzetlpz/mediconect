<!-- consultation.component.html -->
<app-navbar></app-navbar>

<div class="consultations-container">
  <div class="consultations-header">
    <h1>Mis Consultas</h1>
    <button class="btn-primary" (click)="openModal()" *ngIf="isPatient()">
      Agendar Nueva Consulta
    </button>
  </div>

  <div class="consultations-layout">
    <div class="consultations-list">
      <div class="list-header">
        <h2>Historial de Consultas</h2>
        <span class="count">{{ consultations.length }}</span>
      </div>

      <div class="consultation-card"
        *ngFor="let consultation of consultations"
        [class.active]="selectedConsultation?.consulta_id === consultation.consulta_id"
        (click)="selectConsultation(consultation)">

        <div class="card-header">
          <div class="reason">{{ consultation.titulo || consultation.tipo }}</div>
          <span class="badge" [ngClass]="consultation.estado">
            {{ consultation.estado === 'en_progreso' ? 'En progreso' :
               consultation.estado === 'completada' ? 'Completada' :
               consultation.estado === 'programada' ? 'Programada' : 'Confirmada' }}
          </span>
        </div>

        <div class="card-meta">
          <span class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            {{ consultation.programada_en | date:'dd/MM/yyyy' }}
          </span>
          <span class="meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            {{ consultation.programada_en | date:'HH:mm' }}
          </span>
        </div>

        <div class="card-type">
          <svg *ngIf="consultation.tipo === 'videollamada'" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="23 7 16 12 23 17 23 7"></polygon>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
          </svg>
          <svg *ngIf="consultation.tipo === 'chat'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <span>{{ consultation.tipo === 'videollamada' ? 'Video' : 'Chat' }}</span>
        </div>
      </div>

      <div class="empty-state" *ngIf="consultations.length === 0">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <p>No hay consultas disponibles</p>
      </div>
    </div>

    <div class="consultation-detail" *ngIf="selectedConsultation">
      <div class="detail-header">
        <h2>Detalles de la Consulta</h2>
      </div>

      <div class="detail-content">
        <div class="detail-section">
          <h3>Información General</h3>
          <div class="info-grid">
            <div class="info-item">
              <label>Título</label>
              <p>{{ selectedConsultation.titulo || 'Sin título' }}</p>
            </div>
            <div class="info-item">
              <label>Tipo</label>
              <p>{{ selectedConsultation.tipo === 'videollamada' ? 'Videollamada' : 'Chat' }}</p>
            </div>
            <div class="info-item">
              <label>Fecha</label>
              <p>{{ selectedConsultation.programada_en | date:'dd/MM/yyyy' }}</p>
            </div>
            <div class="info-item">
              <label>Hora</label>
              <p>{{ selectedConsultation.programada_en | date:'HH:mm' }}</p>
            </div>
            <div class="info-item">
              <label>Estado</label>
              <p>{{ selectedConsultation.estado }}</p>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedConsultation.descripcion">
          <h3>Descripción</h3>
          <p>{{ selectedConsultation.descripcion }}</p>
        </div>

        <div class="detail-actions">
          <button
            *ngIf="selectedConsultation.estado === 'programada' || selectedConsultation.estado === 'confirmada'"
            class="btn-primary"
            (click)="startConsultation($event, selectedConsultation.consulta_id?.toString() || '')">
            Iniciar Consulta
          </button>
          <button
            class="btn-secondary"
            (click)="deleteConsultation($event, selectedConsultation.consulta_id?.toString() || '')">
            Cancelar Consulta
          </button>
        </div>
      </div>
    </div>

    <div class="no-selection" *ngIf="!selectedConsultation && consultations.length > 0">
      <p>Selecciona una consulta para ver los detalles</p>
    </div>
  </div>
</div>

<!-- Modal para crear consulta -->
<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Agendar Nueva Consulta</h2>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>

    <form [formGroup]="consultationForm" (ngSubmit)="onSubmit()" class="modal-form">
      <div class="form-group">
        <label for="titulo">Título de la Consulta</label>
        <input
          id="titulo"
          type="text"
          formControlName="titulo"
          placeholder="Ej: Consulta de seguimiento"
          [class.error]="titulo?.invalid && titulo?.touched"
        />
        <span class="error-text" *ngIf="titulo?.invalid && titulo?.touched">
          El título es requerido
        </span>
      </div>

      <div class="form-group">
        <label for="descripcion">Descripción / Motivo</label>
        <textarea
          id="descripcion"
          formControlName="descripcion"
          placeholder="Describe brevemente el motivo de tu consulta..."
          [class.error]="descripcion?.invalid && descripcion?.touched"
        ></textarea>
        <span class="error-text" *ngIf="descripcion?.invalid && descripcion?.touched">
          Mínimo 5 caracteres
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="tipo">Tipo de Consulta</label>
          <select id="tipo" formControlName="tipo">
            <option value="videollamada">Videollamada</option>
            <option value="chat">Chat</option>
            <option value="presencial">Presencial</option>
          </select>
        </div>

        <div class="form-group">
          <label for="programada_en">Fecha y Hora</label>
          <input
            id="programada_en"
            type="datetime-local"
            formControlName="programada_en"
            [class.error]="programada_en?.invalid && programada_en?.touched"
          />
          <span class="error-text" *ngIf="programada_en?.invalid && programada_en?.touched">
            La fecha y hora son requeridas
          </span>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button type="submit" class="btn-primary" [disabled]="consultationForm.invalid || isLoading">
          {{ isLoading ? 'Agendando...' : 'Agendar Consulta' }}
        </button>
      </div>
    </form>
  </div>
</div>
