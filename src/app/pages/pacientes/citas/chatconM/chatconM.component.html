<div class="dashboard-layout">
  <!-- Sidebar del Paciente -->
  <appP/>
  <div class="container">
    <div class="header">
      <h1 class="title">Mis Consultas Médicas</h1>
      <p class="subtitle">Comunícate con tus médicos especializados en tiempo real</p>
    </div>

    <div class="layout">
      <!-- Lista de Consultas -->
      <div class="consultas-sidebar">
        <div class="search-container">
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Buscar por médico o motivo..."
            [(ngModel)]="searchQuery"
          />
        </div>

        <div class="consultas-list">
          <!-- Empty State -->
          <div *ngIf="filteredConsultas.length === 0"
               style="text-align: center; padding: 2rem; color: #9ca3af;">
            <p>No se encontraron consultas</p>
          </div>

          <!-- Consulta Cards -->
          <div class="consulta-card"
               *ngFor="let consulta of filteredConsultas"
               [class.active]="isConsultaActive(consulta)"
               (click)="selectConsulta(consulta)">
            <div class="consulta-header">
              <h3 class="consulta-motivo">{{ consulta.motivo }}</h3>
              <span class="consulta-status" [ngClass]="getStatusClass(consulta.estado)">
                {{ consulta.estado }}
              </span>
            </div>

            <div class="consulta-modalidad">
              <!-- Video Icon -->
              <svg *ngIf="getModalityIcon(consulta.modalidad) === 'video'"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              <!-- Chat Icon -->
              <svg *ngIf="getModalityIcon(consulta.modalidad) === 'chat'"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              {{ consulta.modalidad }}
            </div>

            <div class="consulta-info">
              <div class="info-row">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ consulta.medico }}
              </div>
              <div class="info-row">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                {{ consulta.especialidad }}
              </div>
            </div>

            <div class="consulta-datetime">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ consulta.fecha }} - {{ consulta.hora }}
            </div>
          </div>
        </div>
      </div>

      <!-- Área de Chat -->
      <div class="chat-area">
        <!-- Empty State -->
        <div class="empty-state" *ngIf="!consultaActiva">
          <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <h3 class="empty-title">Selecciona una consulta</h3>
          <p class="empty-text">Elige una consulta para comunicarte con tu médico</p>
        </div>

        <!-- Contenido del Chat -->
        <ng-container *ngIf="consultaActiva">
          <div class="chat-header">
            <div class="chat-header-info">
              <div class="chat-avatar medico-avatar">
                {{ getMedicoIniciales(consultaActiva.medico) }}
              </div>
              <div class="chat-details">
                <h3>{{ consultaActiva.medico }}</h3>
                <p>{{ consultaActiva.especialidad }} • {{ consultaActiva.motivo }}</p>
              </div>
            </div>
            <div class="chat-status">
              <span class="status-indicator" [ngClass]="getStatusClass(consultaActiva.estado)">
                ● {{ consultaActiva.estado }}
              </span>
            </div>
          </div>

          <div class="chat-messages" #chatMessages>
            <!-- Mensaje de estado si la consulta no está en progreso -->
            <div class="info-message" *ngIf="consultaActiva.estado !== 'En progreso'">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
              <p>{{ getEstadoDescripcion(consultaActiva.estado) }}</p>
            </div>

            <!-- Mensajes -->
            <div class="message"
                 *ngFor="let mensaje of consultaActiva.mensajes"
                 [class.sent]="mensaje.remitente === 'paciente'"
                 [class.received]="mensaje.remitente === 'medico'">
              <div class="message-avatar"
                   [class.paciente-avatar]="mensaje.remitente === 'paciente'"
                   [class.medico-avatar]="mensaje.remitente === 'medico'">
                {{ mensaje.iniciales }}
              </div>
              <div class="message-content">
                <div class="message-bubble">{{ mensaje.texto }}</div>
                <div class="message-time">{{ mensaje.timestamp }}</div>
              </div>
            </div>
          </div>

          <div class="chat-input-container">
            <!-- Mensaje si no puede enviar -->
            <div class="input-disabled-message" *ngIf="!canSendMessage()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              <span>No puedes enviar mensajes en este momento</span>
            </div>

            <!-- Input de chat -->
            <div class="chat-input-wrapper" *ngIf="canSendMessage()">
              <textarea
                class="chat-input"
                placeholder="Escribe tu mensaje al médico..."
                rows="1"
                [(ngModel)]="nuevoMensaje"
                (keypress)="onKeyPress($event)"
              ></textarea>
              <button class="btn-send"
                      (click)="sendMessage()"
                      [disabled]="!nuevoMensaje.trim()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Enviar
              </button>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>
