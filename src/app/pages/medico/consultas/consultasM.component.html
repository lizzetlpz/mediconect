<div class="dashboard-layout">
  <!-- Sidebar -->
  <appD></appD>
<div class="container">
    <div class="header">
        <h1 class="title">Consultas Médicas</h1>
        <p class="subtitle">Chat en tiempo real con médicos especializados</p>
    </div>

    <div class="layout">
        <!-- Consultas List -->
        <div class="consultas-sidebar">
            <div class="search-container">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    placeholder="Buscar consulta..."
                    [(ngModel)]="searchQuery"
                />
            </div>

            <div class="consultas-list">
                <!-- Empty State -->
                <div *ngIf="filteredConsultas.length === 0"
                     style="text-align: center; padding: 2rem; color: #9ca3af;">
                    <p>No se encontraron consultas</p>
                </div>

                <!-- Consulta Cards -->
                <div class="consulta-card"
                     *ngFor="let consulta of filteredConsultas"
                     [class.active]="isConsultaActive(consulta)"
                     (click)="selectConsulta(consulta)">
                    <div class="consulta-header">
                        <h3 class="consulta-motivo">{{ consulta.motivo }}</h3>
                        <span class="consulta-status" [ngClass]="getStatusClass(consulta.estado)">
                            {{ consulta.estado }}
                        </span>
                    </div>

                    <div class="consulta-modalidad">
                        <!-- Video Icon -->
                        <svg *ngIf="getModalityIcon(consulta.modalidad) === 'video'"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        <!-- Chat Icon -->
                        <svg *ngIf="getModalityIcon(consulta.modalidad) === 'chat'"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        {{ consulta.modalidad }}
                    </div>

                    <div class="consulta-info">
                        <div class="info-row">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            {{ consulta.paciente.nombre }}
                        </div>
                        <div class="info-row">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            {{ consulta.medico.nombre }}
                        </div>
                    </div>

                    <div class="consulta-datetime">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        {{ consulta.fecha }} - {{ consulta.hora }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <!-- Empty State -->
            <div class="empty-state" *ngIf="!consultaActiva">
                <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <h3 class="empty-title">Selecciona una consulta</h3>
                <p class="empty-text">Elige una cita confirmada para iniciar la consulta médica</p>
            </div>

            <!-- Chat Content -->
            <ng-container *ngIf="consultaActiva">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-avatar">
                            {{ getPacienteIniciales(consultaActiva.paciente.nombre) }}
                        </div>
                        <div class="chat-details">
                            <h3>{{ consultaActiva.motivo }}</h3>
                            <p>{{ consultaActiva.paciente.nombre }} • {{ consultaActiva.medico.nombre }}</p>

                            <!-- Estado de conexión -->
                            <div class="connection-status">
                                <span class="status-indicator"
                                      [class.connected]="chatConectado"
                                      [class.disconnected]="!chatConectado">
                                </span>
                                <span class="status-text">{{ chatConectado ? 'En línea' : 'Desconectado' }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-actions">
                        <!-- Iniciar videollamada (solo para modalidad video) -->
                        <button *ngIf="esVideollamada(consultaActiva)"
                                class="action-btn video-btn"
                                (click)="iniciarVideollamada()"
                                [disabled]="!chatConectado || llamadaEnProgreso"
                                title="Iniciar videollamada">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                </path>
                            </svg>
                            {{ llamadaEnProgreso ? 'En llamada' : 'Videollamada' }}
                        </button>

                        <!-- Finalizar consulta -->
                        <button class="action-btn end-btn" (click)="finalizarConsulta()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" #chatMessages>
                    <div class="message"
                         *ngFor="let mensaje of mensajes"
                         [class.sent]="mensaje.remitente === 'medico'"
                         [class.received]="mensaje.remitente === 'paciente'">
                        <div class="message-avatar">{{ getIniciales(mensaje.nombre) }}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-name">{{ mensaje.nombre }}</span>
                                <span class="message-time">{{ formatearTiempoMensaje(mensaje.timestamp) }}</span>
                            </div>
                            <div class="message-bubble">{{ mensaje.texto }}</div>
                        </div>
                    </div>

                    <!-- Mensaje de estado si no hay mensajes -->
                    <div *ngIf="mensajes.length === 0" class="no-messages">
                        <p>La consulta ha comenzado. Envía un mensaje para iniciar la conversación.</p>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            class="chat-input"
                            placeholder="Escribe un mensaje..."
                            rows="1"
                            [(ngModel)]="nuevoMensaje"
                            (keypress)="onKeyPress($event)"
                        ></textarea>
                        <button class="btn-send" (click)="sendMessage()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Enviar
                        </button>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>

    <!-- Video Call Component (Modal) -->
    <app-video-call
        *ngIf="mostrarVideollamada && consultaActiva"
        [consultaId]="consultaActiva.id"
        [participantName]="consultaActiva.paciente.nombre"
        [currentUserRole]="'doctor'"
        [currentUserId]="usuarioActual?.id"
        [canStartVideoCall]="true"
        (callEnded)="cerrarVideollamada()"
        (callStarted)="llamadaEnProgreso = true"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; background: rgba(0,0,0,0.9);">
    </app-video-call>
</div>
</div>
