<div class="dashboard-layout">
  <!-- Sidebar -->
  <appD></appD>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
      <div class="header">
        <div class="header-text">
          <h1 class="title">Historial Médico</h1>
          <p class="subtitle">Registro completo de consultas y tratamientos médicos</p>
        </div>
        <button class="btn-nuevo-registro" (click)="mostrarModal = true">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Nuevo Registro
        </button>
      </div>

      <!-- Search Bar -->
      <div class="search-container">
        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          class="search-input"
          placeholder="Buscar por paciente, médico, diagnóstico o motivo..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange(searchQuery)"
        />
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading">
        <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
        </svg>
        <p>Cargando historial médico...</p>
      </div>

      <!-- Medical Records List -->
      <div class="records-list" *ngIf="!isLoading">
        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredRecords.length === 0">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p>No se encontraron registros médicos</p>
          <button class="btn-primary" (click)="mostrarModal = true" *ngIf="registros.length === 0">
            Crear primer registro
          </button>
        </div>

        <!-- Record Cards -->
        <div class="record-card" *ngFor="let record of filteredRecords">
          <div class="record-header">
            <div class="record-title-section">
              <svg class="record-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <h3 class="record-title">{{ record.motivo }}</h3>
            </div>
            <div class="record-date">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <span>{{ record.fecha }}</span>
            </div>
            <button class="btn-ver-detalles" (click)="verDetalles(record.id)">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              Ver Detalles
            </button>
          </div>

          <div class="record-people">
            <div class="person-section">
              <div class="person-label patient">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Paciente
              </div>
              <p class="person-name">
                {{ record.paciente || 'Paciente no especificado' }}
              </p>
            </div>

            <div class="person-section">
              <div class="person-label doctor">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                Médico
              </div>
              <p class="person-name">
                {{ record.medico || 'Médico no especificado' }}
              </p>
            </div>
          </div>

          <div class="record-info">
            <div class="info-section">
              <div class="info-label">Síntomas:</div>
              <p class="info-text">{{ record.sintomas || 'No especificados' }}</p>
            </div>

            <div class="info-section">
              <div class="info-label">Diagnóstico:</div>
              <p class="info-text">{{ record.diagnostico || 'No especificado' }}</p>
            </div>

            <div class="medications-section" *ngIf="record.medicamentos && record.medicamentos.length > 0">
              <div class="medications-label">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                Medicamentos Recetados:
              </div>
              <div class="medications-list">
                <span
                  class="medication-badge medication-{{ med.tipo }}"
                  *ngFor="let med of record.medicamentos">
                  {{ med.nombre }}
                </span>
              </div>
            </div>

            <div class="medications-section" *ngIf="!record.medicamentos || record.medicamentos.length === 0">
              <div class="medications-label">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                Medicamentos Recetados:
              </div>
              <p class="info-text">Sin medicamentos recetados</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Crear Registro -->
<app-agregarR
  *ngIf="mostrarModal"
  (cerrar)="mostrarModal = false"
  (registroCreado)="onRegistroCreado()">
  <!-- ✅ CAMBIO: Quitar el parámetro $event -->
</app-agregarR>

<!-- Modal Detalles del Registro Médico -->
<app-medical-detail></app-medical-detail>
